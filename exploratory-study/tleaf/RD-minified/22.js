"use strict";var esprima=require("esprima"),estraverse=require("estraverse"),escope=require("escope"),_=require(),config=require("./config"),UserError=require("./error/UserError");function parse(e){var r;try{r=esprima.parse(e)}catch(e){throw new UserError("Source file is not valid.",e)}var t=escope.analyze(r),n=t.acquire(),a=[];estraverse.traverse(r,{enter:function(e){if("CallExpression"===e.type){var r=_.get(e,"callee.property",{});_.contains(config.units.process,r.name)&&a.push({node:e,scope:n})}/Function/.test(e.type)&&(n=t.acquire(e))},leave:function(e){/Function/.test(e.type)&&(n=n.upper)}});return _.forEach(a),[]}function findName(e){var r,t=_.get(e,"arguments[0]");return"Literal"===t.type&&(r=t.value),r}function findType(e){return _.get(e,"callee.property.name")}function findModule(e,r){var t={},n=_.get(e,"callee.object",{}),a=_.get(e,"callee.property",{});if("CallExpression"===n.type)return findModule(n,r);if("Identifier"===n.type)if("module"===a.name&&"angular"===n.name)t.name=_.get(e,"arguments[0].value");else if(_.contains(config.units.process,a.name)){var i=findVariable(n.name,r);i&&(t.name=_.get(i,"init.arguments[0].value"))}return t}function findDeps(e,r,t){if(_.contains(["filter","value","constant"],t))return[];var n=_.get(e,"arguments[1]",{});if("component"!==t){if("ArrayExpression"===n.type){var a=_.last(n.elements)||{};if("FunctionExpression"===a.type)return extractDeps(a.params)}return"Identifier"===n.type?extractVariableDeps(n.name,r):"FunctionExpression"===n.type?"provider"!==t?extractDeps(n.params):findProviderDeps(n):[]}}function findComponentDeps(e,r){return"Identifier"===e.type&&(e=_.get(findVariable(e.name,r),"init",{})),"ObjectExpression"!==e.type?[]:extractObjectPropertyDeps(e,"controller",r)}function findProviderDeps(e){var r=_.get(e,"body",{});if("BlockStatement"!==r.type)return[];findScope(e),_.get(r);return[]}function extractDeps(e){if(_.isArray(e)){var r=[];return _.forEach(e,function(e){if("Identifier"===e.type){var t={name:e.name};r.push(t)}}),r}}function findVariable(e,r){for(var t,n=r;!t&&n;)t=_.findWhere(n.variables,{name:e}),n=n.upper;if(_.isUndefined(t))return t}function extractVariableDeps(e){var r=findVariable(e,scope),t=[],n=_.get(r);return"FunctionDeclaration"===n&&(t=_.get(r,"params",[])),"VariableDeclarator"===n&&(t=_.get(r,"init.params")),extractDeps(t)}function extractObjectPropertyDeps(e,r,t){var n=_.find(e.properties,function(e){return _.get(e,"key.name")===r});if(!n)return[];var a=_.get(n,"value",{}),i=[];return"FunctionExpression"===a.type&&(i=extractDeps(a.params)),"Identifier"===a.type&&(i=extractVariableDeps(a.name,t)),i}module.exports=parse;