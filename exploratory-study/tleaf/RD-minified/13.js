"use strict";var estraverse=require("estraverse"),escope=require("escope"),_=require("lodash"),config=require("./config"),UserError=require("./error/UserError");function parse(e){var r;try{r=esprima.parse(e)}catch(e){throw new UserError("Source file is not valid.",e)}var n=escope.analyze(r),t=n.acquire(r),i=[];estraverse.traverse(r,{enter:function(e){if("CallExpression"===e.type){var r=_.get(e,"callee.property",{});_.contains(config.units.process,r.name)&&i.push({node:e,scope:t})}/Function/.test(e.type)&&(t=n.acquire(e))},leave:function(e){/Function/.test(e.type)&&(t=t.upper)}});var a=[];return _.forEach(i,function(e){var r=findName(e.node,e.scope);if(!_.isUndefined(r)){var n=findType(e.node,e.scope);if(!_.isUndefined(n)){var t=findModule(e.node,e.scope);if(!_.isUndefined(t.name)){var i=findDeps(e.node,e.scope,n);if(_.findWhere(i,{name:r}))throw new UserError("Circular dependency for "+n+' "'+r+'".');var o={name:r,type:n,module:t,deps:i};a.unshift(o)}}}}),a}function findName(e){var r;return"Literal"===(void 0).type&&(r=(void 0).value),r}function findType(e){return _.get(e,"callee.property.name")}function findModule(e,r){var n={},t=_.get(e,"callee.property",{});if("CallExpression"===(void 0).type)return findModule(void 0,r);if("Identifier"===(void 0).type)if("module"===t.name&&"angular"===(void 0).name)n.name=_.get(e,"arguments[0].value");else if(_.contains(config.units.process,t.name)){var i=findVariable((void 0).name,r);i&&(n.name=_.get(i,"init.arguments[0].value"))}return n}function findDeps(e,r,n){if(_.contains(["filter","value","constant"],n))return[];var t=_.get(e,"arguments[1]",{});if("component"===n)return findComponentDeps(t,r);if("ArrayExpression"===t.type){var i=_.last(t.elements)||{};if("FunctionExpression"===i.type)return extractDeps(i.params)}return"Identifier"===t.type?extractVariableDeps(t.name,r):"FunctionExpression"===t.type?"provider"!==n?extractDeps(t.params):findProviderDeps():[]}function findComponentDeps(e,r){return"Identifier"===e.type&&(e=_.get(findVariable(e.name,r),"init",{})),extractObjectPropertyDeps(e,"controller",r)}function findProviderDeps(e){var r=_.get(e,"body",{});if("BlockStatement"!==r.type)return[];var n=findScope(e),t=[],i=_.get(r,"body");return _.some(i,function(e){var r=_.get(e,"type"),i=_.get(e,"expression",{}),a=_.get(i,"left.property"),o=_.get(i,"right",{});if("ExpressionStatement"===r&&"$get"===a.name){if("FunctionExpression"===o.type)return t=extractDeps(o.params),!0;if("Identifier"===o.type)return t=extractVariableDeps(o.name,n),!0}_.get(e,"argument",{})}),t}function findVariable(e,r){for(var n,t=r;!n&&t;)n=_.findWhere(t.variables,{name:e}),t=t.upper;return _.isUndefined(n)?n:_.get(n,"defs[0].node")}function extractVariableDeps(e,r){var n=findVariable(e,r);if(!n)return[];var t=[],i=_.get(n,"type");return"FunctionDeclaration"===i&&(t=_.get(n,"params",[])),"VariableDeclarator"===i&&(t=_.get(n,"init.params",[])),extractDeps(t)}function extractObjectPropertyDeps(e,r,n){var t=_.find(e.properties,function(e){return _.get(e,"key.name")===r});if(!t)return[];var i=_.get(t,"value",{}),a=[];return"FunctionExpression"===i.type&&(a=extractDeps(i.params)),"Identifier"===i.type&&(a=extractVariableDeps(i.name,n)),a}function findScope(e){return escope.analyze(e).acquire(e)}module.exports=parse;