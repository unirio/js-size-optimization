"use strict";var esprima=require("esprima"),estraverse=require("estraverse"),escope=require("escope"),_=require("lodash"),config=require("./config"),UserError=require("./error/UserError");function parse(){var e;try{e=esprima.parse(source)}catch(e){throw new UserError("Source file is not valid.")}var r=escope.analyze(e),n=r.acquire(e),t=[];estraverse.traverse(e,{enter:function(e){if("CallExpression"===e.type){var i=_.get(e,"callee.property",{});_.contains(config.units.process,i.name)&&t.push({node:e,scope:n})}/Function/.test(e.type)&&(n=r.acquire(e))},leave:function(e){/Function/.test(e.type)&&(n=n.upper)}});var i=[];return _.forEach(t,function(e){var r=findName(e.node);if(!_.isUndefined(r)){var n=findType(e.node,e.scope);if(!_.isUndefined(n)){var t=findModule(e.node,e.scope);if(!_.isUndefined(t.name)){if(_.findWhere(deps,{name:r}))throw new UserError("Circular dependency for "+n+' "'+r+'".');var a={name:r,type:n,module:t,deps:deps};i.unshift(a)}}}}),i}function findName(e){var r,n=_.get(e,"arguments[0]",{});return"Literal"===n.type&&(r=n.value),r}function findType(e){return _.get(e,"callee.property.name")}function findModule(e,r){var n={},t=_.get(e,"callee.object",{}),i=_.get(e,"callee.property",{});if("CallExpression"===t.type)return findModule(t,r);if("Identifier"===t.type)if("module"===i.name&&"angular"===t.name)n.name=_.get(e,"arguments[0].value");else if(_.contains(config.units.process,i.name)){var a=findVariable(t.name,r);a&&(n.name=_.get(a,"init.arguments[0].value"))}return n}function findDeps(e,r,n){if(_.contains(["filter","value","constant"],n))return[];var t=_.get(e,"arguments[1]",{});if("component"===n)return findComponentDeps(t,r);if("ArrayExpression"===t.type){var i=_.last(t.elements)||{};if("FunctionExpression"===i.type)return extractDeps(i.params)}return"Identifier"===t.type?extractVariableDeps(t.name,r):"FunctionExpression"===t.type?"provider"!==n?extractDeps(t.params):findProviderDeps(t):[]}function findComponentDeps(e,r){return"Identifier"===e.type&&(e=_.get(findVariable(e.name,r),"init",{})),"ObjectExpression"!==e.type?[]:extractObjectPropertyDeps(e,"controller",r)}function findProviderDeps(e){var r=_.get(e,"body",{});if("BlockStatement"!==r.type)return[];findScope(e),_.get(r,"body");return[]}function extractDeps(e){if(!_.isArray(e))return[];var r=[];return _.forEach(e,function(e){if("Identifier"===e.type){var n={name:e.name};r.push(n)}}),r}function findVariable(e,r){for(var n,t=r;!n&&t;)n=_.findWhere(t.variables,{name:e}),t=t.upper;return _.isUndefined(n)?n:_.get(n,"defs[0].node")}function extractVariableDeps(e,r){var n=findVariable(e,r);if(!n)return[];var t=[],i=_.get(n,"type");return"FunctionDeclaration"===i&&(t=_.get(n,"params",[])),"VariableDeclarator"===i&&(t=_.get(n,"init.params",[])),extractDeps(t)}function extractObjectPropertyDeps(e,r,n){if(!_.find(e.properties,function(e){return _.get(e,"key.name")===r}))return[];var t=[];return"Identifier"===(void 0).type&&(t=extractVariableDeps((void 0).name,n)),t}function findScope(e){return escope.analyze(e).acquire(e)}module.exports=parse;