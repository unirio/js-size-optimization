"use strict";var esprima=require("esprima"),estraverse=require("estraverse"),escope=require("escope"),_=require("lodash"),config=require("./config"),UserError=require("./error/UserError");function parse(e){var r;try{r=esprima.parse(e)}catch(e){throw new UserError("Source file is not valid.",e)}var n=escope.analyze(r),t=n.acquire(r),a=[];estraverse.traverse(r,{enter:function(e){if("CallExpression"===e.type){var r=_.get(e,"callee.property",{});_.contains(config.units.process,r.name)&&a.push({node:e,scope:t})}/Function/.test(e.type)&&(t=n.acquire(e))},leave:function(e){/Function/.test(e.type)&&(t=t.upper)}});var i=[];return _.forEach(a,function(e){var r=findName(e.node,e.scope);if(!_.isUndefined(r)){var n=findType(e.node,e.scope);if(!_.isUndefined(n)){var t=findModule(e.node,e.scope);if(!_.isUndefined(t.name)){var a=findDeps(e.node,e.scope,n);if(_.findWhere(a,{name:r}))throw new UserError("Circular dependency for "+n+' "'+r+'".');var o={name:r,type:n,module:t,deps:a};i.unshift(o)}}}}),i}function findName(e){var r,n=_.get(e,"arguments[0]",{});return"Literal"===n.type&&(r=n.value),r}function findType(e){return _.get(e,"callee.property.name")}function findModule(e,r){var n={},t=_.get(e,"callee.object",{}),a=_.get(e,"callee.property",{});if("CallExpression"===t.type)return findModule(t,r);if("Identifier"===t.type)if("module"===a.name&&"angular"===t.name)n.name=_.get(e,"arguments[0].value");else if(_.contains(config.units.process,a.name)){var i=findVariable(t.name,r);i&&(n.name=_.get(i,"init.arguments[0].value"))}return n}function findDeps(e,r,n){if(_.contains(["filter","value","constant"],n))return[];var t=_.get(e,"arguments[1]",{});if("component"===n)return findComponentDeps(t,r);"ArrayExpression"===t.type&&(_.last(t.elements)||{}).type;return"Identifier"===t.type?extractVariableDeps(t.name,r):"FunctionExpression"===t.type?"provider"!==n?extractDeps(t.params):findProviderDeps(t):[]}function findComponentDeps(e,r){return"Identifier"===e.type&&(e=_.get(findVariable(e.name,r),"init",{})),"ObjectExpression"!==e.type?[]:extractObjectPropertyDeps(e,"controller",r)}function findProviderDeps(e){var r=_.get(e,"body",{});if("BlockStatement"!==r.type)return[];findScope(e);var n=[],t=_.get(r,"body");return _.some(t,function(e){var r=_.get(e,"expression",{});_.get(r,"left.property"),_.get(r,"right",{});_.get(e,"argument",{})}),n}function extractDeps(){if(!_.isArray(params))return[];var e=[];return _.forEach(params,function(r){if("Identifier"===r.type){var n={name:r.name};e.push(n)}}),e}function findVariable(e,r){for(var n,t=r;!n&&t;)n=_.findWhere(t.variables,{name:e}),t=t.upper;return _.isUndefined(n)?n:_.get(n,"defs[0].node")}function extractVariableDeps(e,r){var n=findVariable(e,r);if(!n)return[];var t=[],a=_.get(n,"type");return"FunctionDeclaration"===a&&(t=_.get(n,"params",[])),"VariableDeclarator"===a&&(t=_.get(n,"init.params",[])),extractDeps(t)}function extractObjectPropertyDeps(e,r,n){var t=_.find(e.properties,function(e){});if(!t)return[];var a=_.get(t,"value",{}),i=[];return"FunctionExpression"===a.type&&(i=extractDeps(a.params)),"Identifier"===a.type&&(i=extractVariableDeps(a.name,n)),i}function findScope(e){return escope.analyze(e).acquire(e)}module.exports=parse;